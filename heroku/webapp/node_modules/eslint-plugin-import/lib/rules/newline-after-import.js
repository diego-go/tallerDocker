'use strict';

var _staticRequire = require('../core/staticRequire');

var _staticRequire2 = _interopRequireDefault(_staticRequire);

var _lodash = require('lodash.findindex');

var _lodash2 = _interopRequireDefault(_lodash);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

//------------------------------------------------------------------------------
// Rule Definition
//------------------------------------------------------------------------------

/**
 * @fileoverview Rule to enforce new line after import not followed by another import.
 * @author Radek Benkel
 */

function containsNodeOrEqual(outerNode, innerNode) {
  return outerNode.range[0] <= innerNode.range[0] && outerNode.range[1] >= innerNode.range[1];
}

function getScopeBody(scope) {
  if (scope.block.type === 'SwitchStatement') {
    return [];
  }

  var body = scope.block.body;

  if (body && body.type === 'BlockStatement') {
    return body.body;
  }

  return body;
}

function findNodeIndexInScopeBody(body, nodeToFind) {
  return (0, _lodash2.default)(body, function (node) {
    return containsNodeOrEqual(node, nodeToFind);
  });
}

function getLineDifference(node, nextNode) {
  return nextNode.loc.start.line - node.loc.end.line;
}

module.exports = function (context) {
  var scopes = [];
  var scopeIndex = 0;

  function checkForNewLine(node, nextNode, type) {
    if (getLineDifference(node, nextNode) < 2) {
      var column = node.loc.start.column;

      if (node.loc.start.line !== node.loc.end.line) {
        column = 0;
      }

      context.report({
        loc: {
          line: node.loc.end.line,
          column: column
        },
        message: 'Expected empty line after ' + type + ' statement not followed by another ' + type + '.'
      });
    }
  }

  return {
    ImportDeclaration: function ImportDeclaration(node) {
      var parent = node.parent;

      var nodePosition = parent.body.indexOf(node);
      var nextNode = parent.body[nodePosition + 1];

      if (nextNode && nextNode.type !== 'ImportDeclaration') {
        checkForNewLine(node, nextNode, 'import');
      }
    },
    Program: function Program() {
      scopes.push({ scope: context.getScope(), requireCalls: [] });
    },
    CallExpression: function CallExpression(node) {
      var scope = context.getScope();
      if ((0, _staticRequire2.default)(node)) {
        var currentScope = scopes[scopeIndex];

        if (scope === currentScope.scope) {
          currentScope.requireCalls.push(node);
        } else {
          scopes.push({ scope: scope, requireCalls: [node] });
          scopeIndex += 1;
        }
      }
    },
    'Program:exit': function ProgramExit() {
      scopes.forEach(function (_ref) {
        var scope = _ref.scope;
        var requireCalls = _ref.requireCalls;

        requireCalls.forEach(function (node, index) {
          var scopeBody = getScopeBody(scope);
          var nodePosition = findNodeIndexInScopeBody(scopeBody, node);
          var statementWithRequireCall = scopeBody[nodePosition];
          var nextStatement = scopeBody[nodePosition + 1];
          var nextRequireCall = requireCalls[index + 1];

          if (nextRequireCall && containsNodeOrEqual(statementWithRequireCall, nextRequireCall)) {
            return;
          }

          if (nextStatement && (!nextRequireCall || !containsNodeOrEqual(nextStatement, nextRequireCall))) {

            checkForNewLine(statementWithRequireCall, nextStatement, 'require');
          }
        });
      });
    }
  };
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInJ1bGVzL25ld2xpbmUtYWZ0ZXItaW1wb3J0LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBS0E7Ozs7QUFDQTs7Ozs7Ozs7Ozs7Ozs7O0FBTUEsU0FBUyxtQkFBVCxDQUE2QixTQUE3QixFQUF3QyxTQUF4QyxFQUFtRDtBQUMvQyxTQUFPLFVBQVUsS0FBVixDQUFnQixDQUFoQixLQUFzQixVQUFVLEtBQVYsQ0FBZ0IsQ0FBaEIsQ0FBdEIsSUFBNEMsVUFBVSxLQUFWLENBQWdCLENBQWhCLEtBQXNCLFVBQVUsS0FBVixDQUFnQixDQUFoQixDQUF6RTtBQUNIOztBQUVELFNBQVMsWUFBVCxDQUFzQixLQUF0QixFQUE2QjtBQUN6QixNQUFJLE1BQU0sS0FBTixDQUFZLElBQVosS0FBcUIsaUJBQXpCLEVBQTRDO0FBQzFDLFdBQU8sRUFBUDtBQUNEOztBQUh3QixNQUtqQixJQUxpQixHQUtSLE1BQU0sS0FMRSxDQUtqQixJQUxpQjs7QUFNekIsTUFBSSxRQUFRLEtBQUssSUFBTCxLQUFjLGdCQUExQixFQUE0QztBQUN4QyxXQUFPLEtBQUssSUFBWjtBQUNIOztBQUVELFNBQU8sSUFBUDtBQUNIOztBQUVELFNBQVMsd0JBQVQsQ0FBa0MsSUFBbEMsRUFBd0MsVUFBeEMsRUFBb0Q7QUFDaEQsU0FBTyxzQkFBVSxJQUFWLEVBQWdCLFVBQUMsSUFBRDtBQUFBLFdBQVUsb0JBQW9CLElBQXBCLEVBQTBCLFVBQTFCLENBQVY7QUFBQSxHQUFoQixDQUFQO0FBQ0g7O0FBRUQsU0FBUyxpQkFBVCxDQUEyQixJQUEzQixFQUFpQyxRQUFqQyxFQUEyQztBQUN6QyxTQUFPLFNBQVMsR0FBVCxDQUFhLEtBQWIsQ0FBbUIsSUFBbkIsR0FBMEIsS0FBSyxHQUFMLENBQVMsR0FBVCxDQUFhLElBQTlDO0FBQ0Q7O0FBR0QsT0FBTyxPQUFQLEdBQWlCLFVBQVUsT0FBVixFQUFtQjtBQUNsQyxNQUFNLFNBQVMsRUFBZjtBQUNBLE1BQUksYUFBYSxDQUFqQjs7QUFFQSxXQUFTLGVBQVQsQ0FBeUIsSUFBekIsRUFBK0IsUUFBL0IsRUFBeUMsSUFBekMsRUFBK0M7QUFDN0MsUUFBSSxrQkFBa0IsSUFBbEIsRUFBd0IsUUFBeEIsSUFBb0MsQ0FBeEMsRUFBMkM7QUFDekMsVUFBSSxTQUFTLEtBQUssR0FBTCxDQUFTLEtBQVQsQ0FBZSxNQUE1Qjs7QUFFQSxVQUFJLEtBQUssR0FBTCxDQUFTLEtBQVQsQ0FBZSxJQUFmLEtBQXdCLEtBQUssR0FBTCxDQUFTLEdBQVQsQ0FBYSxJQUF6QyxFQUErQztBQUM3QyxpQkFBUyxDQUFUO0FBQ0Q7O0FBRUQsY0FBUSxNQUFSLENBQWU7QUFDYixhQUFLO0FBQ0gsZ0JBQU0sS0FBSyxHQUFMLENBQVMsR0FBVCxDQUFhLElBRGhCO0FBRUg7QUFGRyxTQURRO0FBS2IsZ0RBQXNDLElBQXRDLDJDQUFnRixJQUFoRjtBQUxhLE9BQWY7QUFPRDtBQUNGOztBQUVELFNBQU87QUFDTCx1QkFBbUIsMkJBQVUsSUFBVixFQUFnQjtBQUFBLFVBQ3pCLE1BRHlCLEdBQ2QsSUFEYyxDQUN6QixNQUR5Qjs7QUFFakMsVUFBTSxlQUFlLE9BQU8sSUFBUCxDQUFZLE9BQVosQ0FBb0IsSUFBcEIsQ0FBckI7QUFDQSxVQUFNLFdBQVcsT0FBTyxJQUFQLENBQVksZUFBZSxDQUEzQixDQUFqQjs7QUFFQSxVQUFJLFlBQVksU0FBUyxJQUFULEtBQWtCLG1CQUFsQyxFQUF1RDtBQUNyRCx3QkFBZ0IsSUFBaEIsRUFBc0IsUUFBdEIsRUFBZ0MsUUFBaEM7QUFDRDtBQUNGLEtBVEk7QUFVTCxhQUFTLG1CQUFZO0FBQ25CLGFBQU8sSUFBUCxDQUFZLEVBQUUsT0FBTyxRQUFRLFFBQVIsRUFBVCxFQUE2QixjQUFjLEVBQTNDLEVBQVo7QUFDRCxLQVpJO0FBYUwsb0JBQWdCLHdCQUFTLElBQVQsRUFBZTtBQUM3QixVQUFNLFFBQVEsUUFBUSxRQUFSLEVBQWQ7QUFDQSxVQUFJLDZCQUFnQixJQUFoQixDQUFKLEVBQTJCO0FBQ3pCLFlBQU0sZUFBZSxPQUFPLFVBQVAsQ0FBckI7O0FBRUEsWUFBSSxVQUFVLGFBQWEsS0FBM0IsRUFBa0M7QUFDaEMsdUJBQWEsWUFBYixDQUEwQixJQUExQixDQUErQixJQUEvQjtBQUNELFNBRkQsTUFFTztBQUNMLGlCQUFPLElBQVAsQ0FBWSxFQUFFLFlBQUYsRUFBUyxjQUFjLENBQUUsSUFBRixDQUF2QixFQUFaO0FBQ0Esd0JBQWMsQ0FBZDtBQUNEO0FBQ0Y7QUFDRixLQXpCSTtBQTBCTCxvQkFBZ0IsdUJBQVk7QUFDMUIsYUFBTyxPQUFQLENBQWUsZ0JBQW1DO0FBQUEsWUFBdkIsS0FBdUIsUUFBdkIsS0FBdUI7QUFBQSxZQUFoQixZQUFnQixRQUFoQixZQUFnQjs7QUFDaEQscUJBQWEsT0FBYixDQUFxQixVQUFVLElBQVYsRUFBZ0IsS0FBaEIsRUFBdUI7QUFDMUMsY0FBTSxZQUFZLGFBQWEsS0FBYixDQUFsQjtBQUNBLGNBQU0sZUFBZSx5QkFBeUIsU0FBekIsRUFBb0MsSUFBcEMsQ0FBckI7QUFDQSxjQUFNLDJCQUEyQixVQUFVLFlBQVYsQ0FBakM7QUFDQSxjQUFNLGdCQUFnQixVQUFVLGVBQWUsQ0FBekIsQ0FBdEI7QUFDQSxjQUFNLGtCQUFrQixhQUFhLFFBQVEsQ0FBckIsQ0FBeEI7O0FBRUEsY0FBSSxtQkFBbUIsb0JBQW9CLHdCQUFwQixFQUE4QyxlQUE5QyxDQUF2QixFQUF1RjtBQUNyRjtBQUNEOztBQUVELGNBQUksa0JBQ0EsQ0FBQyxlQUFELElBQW9CLENBQUMsb0JBQW9CLGFBQXBCLEVBQW1DLGVBQW5DLENBRHJCLENBQUosRUFDK0U7O0FBRTdFLDRCQUFnQix3QkFBaEIsRUFBMEMsYUFBMUMsRUFBeUQsU0FBekQ7QUFDRDtBQUNGLFNBaEJEO0FBaUJELE9BbEJEO0FBbUJEO0FBOUNJLEdBQVA7QUFnREQsQ0F0RUQiLCJmaWxlIjoicnVsZXMvbmV3bGluZS1hZnRlci1pbXBvcnQuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBmaWxlb3ZlcnZpZXcgUnVsZSB0byBlbmZvcmNlIG5ldyBsaW5lIGFmdGVyIGltcG9ydCBub3QgZm9sbG93ZWQgYnkgYW5vdGhlciBpbXBvcnQuXG4gKiBAYXV0aG9yIFJhZGVrIEJlbmtlbFxuICovXG5cbmltcG9ydCBpc1N0YXRpY1JlcXVpcmUgZnJvbSAnLi4vY29yZS9zdGF0aWNSZXF1aXJlJ1xuaW1wb3J0IGZpbmRJbmRleCBmcm9tICdsb2Rhc2guZmluZGluZGV4J1xuXG4vLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuLy8gUnVsZSBEZWZpbml0aW9uXG4vLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuXG5mdW5jdGlvbiBjb250YWluc05vZGVPckVxdWFsKG91dGVyTm9kZSwgaW5uZXJOb2RlKSB7XG4gICAgcmV0dXJuIG91dGVyTm9kZS5yYW5nZVswXSA8PSBpbm5lck5vZGUucmFuZ2VbMF0gJiYgb3V0ZXJOb2RlLnJhbmdlWzFdID49IGlubmVyTm9kZS5yYW5nZVsxXVxufVxuXG5mdW5jdGlvbiBnZXRTY29wZUJvZHkoc2NvcGUpIHtcbiAgICBpZiAoc2NvcGUuYmxvY2sudHlwZSA9PT0gJ1N3aXRjaFN0YXRlbWVudCcpIHtcbiAgICAgIHJldHVybiBbXVxuICAgIH1cblxuICAgIGNvbnN0IHsgYm9keSB9ID0gc2NvcGUuYmxvY2tcbiAgICBpZiAoYm9keSAmJiBib2R5LnR5cGUgPT09ICdCbG9ja1N0YXRlbWVudCcpIHtcbiAgICAgICAgcmV0dXJuIGJvZHkuYm9keVxuICAgIH1cblxuICAgIHJldHVybiBib2R5XG59XG5cbmZ1bmN0aW9uIGZpbmROb2RlSW5kZXhJblNjb3BlQm9keShib2R5LCBub2RlVG9GaW5kKSB7XG4gICAgcmV0dXJuIGZpbmRJbmRleChib2R5LCAobm9kZSkgPT4gY29udGFpbnNOb2RlT3JFcXVhbChub2RlLCBub2RlVG9GaW5kKSlcbn1cblxuZnVuY3Rpb24gZ2V0TGluZURpZmZlcmVuY2Uobm9kZSwgbmV4dE5vZGUpIHtcbiAgcmV0dXJuIG5leHROb2RlLmxvYy5zdGFydC5saW5lIC0gbm9kZS5sb2MuZW5kLmxpbmVcbn1cblxuXG5tb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIChjb250ZXh0KSB7XG4gIGNvbnN0IHNjb3BlcyA9IFtdXG4gIGxldCBzY29wZUluZGV4ID0gMFxuXG4gIGZ1bmN0aW9uIGNoZWNrRm9yTmV3TGluZShub2RlLCBuZXh0Tm9kZSwgdHlwZSkge1xuICAgIGlmIChnZXRMaW5lRGlmZmVyZW5jZShub2RlLCBuZXh0Tm9kZSkgPCAyKSB7XG4gICAgICBsZXQgY29sdW1uID0gbm9kZS5sb2Muc3RhcnQuY29sdW1uXG5cbiAgICAgIGlmIChub2RlLmxvYy5zdGFydC5saW5lICE9PSBub2RlLmxvYy5lbmQubGluZSkge1xuICAgICAgICBjb2x1bW4gPSAwXG4gICAgICB9XG5cbiAgICAgIGNvbnRleHQucmVwb3J0KHtcbiAgICAgICAgbG9jOiB7XG4gICAgICAgICAgbGluZTogbm9kZS5sb2MuZW5kLmxpbmUsXG4gICAgICAgICAgY29sdW1uLFxuICAgICAgICB9LFxuICAgICAgICBtZXNzYWdlOiBgRXhwZWN0ZWQgZW1wdHkgbGluZSBhZnRlciAke3R5cGV9IHN0YXRlbWVudCBub3QgZm9sbG93ZWQgYnkgYW5vdGhlciAke3R5cGV9LmAsXG4gICAgICB9KVxuICAgIH1cbiAgfVxuXG4gIHJldHVybiB7XG4gICAgSW1wb3J0RGVjbGFyYXRpb246IGZ1bmN0aW9uIChub2RlKSB7XG4gICAgICBjb25zdCB7IHBhcmVudCB9ID0gbm9kZVxuICAgICAgY29uc3Qgbm9kZVBvc2l0aW9uID0gcGFyZW50LmJvZHkuaW5kZXhPZihub2RlKVxuICAgICAgY29uc3QgbmV4dE5vZGUgPSBwYXJlbnQuYm9keVtub2RlUG9zaXRpb24gKyAxXVxuXG4gICAgICBpZiAobmV4dE5vZGUgJiYgbmV4dE5vZGUudHlwZSAhPT0gJ0ltcG9ydERlY2xhcmF0aW9uJykge1xuICAgICAgICBjaGVja0Zvck5ld0xpbmUobm9kZSwgbmV4dE5vZGUsICdpbXBvcnQnKVxuICAgICAgfVxuICAgIH0sXG4gICAgUHJvZ3JhbTogZnVuY3Rpb24gKCkge1xuICAgICAgc2NvcGVzLnB1c2goeyBzY29wZTogY29udGV4dC5nZXRTY29wZSgpLCByZXF1aXJlQ2FsbHM6IFtdIH0pXG4gICAgfSxcbiAgICBDYWxsRXhwcmVzc2lvbjogZnVuY3Rpb24obm9kZSkge1xuICAgICAgY29uc3Qgc2NvcGUgPSBjb250ZXh0LmdldFNjb3BlKClcbiAgICAgIGlmIChpc1N0YXRpY1JlcXVpcmUobm9kZSkpIHtcbiAgICAgICAgY29uc3QgY3VycmVudFNjb3BlID0gc2NvcGVzW3Njb3BlSW5kZXhdXG5cbiAgICAgICAgaWYgKHNjb3BlID09PSBjdXJyZW50U2NvcGUuc2NvcGUpIHtcbiAgICAgICAgICBjdXJyZW50U2NvcGUucmVxdWlyZUNhbGxzLnB1c2gobm9kZSlcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBzY29wZXMucHVzaCh7IHNjb3BlLCByZXF1aXJlQ2FsbHM6IFsgbm9kZSBdIH0pXG4gICAgICAgICAgc2NvcGVJbmRleCArPSAxXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9LFxuICAgICdQcm9ncmFtOmV4aXQnOiBmdW5jdGlvbiAoKSB7XG4gICAgICBzY29wZXMuZm9yRWFjaChmdW5jdGlvbiAoeyBzY29wZSwgcmVxdWlyZUNhbGxzIH0pIHtcbiAgICAgICAgcmVxdWlyZUNhbGxzLmZvckVhY2goZnVuY3Rpb24gKG5vZGUsIGluZGV4KSB7XG4gICAgICAgICAgY29uc3Qgc2NvcGVCb2R5ID0gZ2V0U2NvcGVCb2R5KHNjb3BlKVxuICAgICAgICAgIGNvbnN0IG5vZGVQb3NpdGlvbiA9IGZpbmROb2RlSW5kZXhJblNjb3BlQm9keShzY29wZUJvZHksIG5vZGUpXG4gICAgICAgICAgY29uc3Qgc3RhdGVtZW50V2l0aFJlcXVpcmVDYWxsID0gc2NvcGVCb2R5W25vZGVQb3NpdGlvbl1cbiAgICAgICAgICBjb25zdCBuZXh0U3RhdGVtZW50ID0gc2NvcGVCb2R5W25vZGVQb3NpdGlvbiArIDFdXG4gICAgICAgICAgY29uc3QgbmV4dFJlcXVpcmVDYWxsID0gcmVxdWlyZUNhbGxzW2luZGV4ICsgMV1cblxuICAgICAgICAgIGlmIChuZXh0UmVxdWlyZUNhbGwgJiYgY29udGFpbnNOb2RlT3JFcXVhbChzdGF0ZW1lbnRXaXRoUmVxdWlyZUNhbGwsIG5leHRSZXF1aXJlQ2FsbCkpIHtcbiAgICAgICAgICAgIHJldHVyblxuICAgICAgICAgIH1cblxuICAgICAgICAgIGlmIChuZXh0U3RhdGVtZW50ICYmXG4gICAgICAgICAgICAgKCFuZXh0UmVxdWlyZUNhbGwgfHwgIWNvbnRhaW5zTm9kZU9yRXF1YWwobmV4dFN0YXRlbWVudCwgbmV4dFJlcXVpcmVDYWxsKSkpIHtcblxuICAgICAgICAgICAgY2hlY2tGb3JOZXdMaW5lKHN0YXRlbWVudFdpdGhSZXF1aXJlQ2FsbCwgbmV4dFN0YXRlbWVudCwgJ3JlcXVpcmUnKVxuICAgICAgICAgIH1cbiAgICAgICAgfSlcbiAgICAgIH0pXG4gICAgfSxcbiAgfVxufVxuIl19