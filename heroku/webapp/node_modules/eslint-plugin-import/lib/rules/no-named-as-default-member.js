'use strict';

var _es6Map = require('es6-map');

var _es6Map2 = _interopRequireDefault(_es6Map);

var _getExports = require('../core/getExports');

var _getExports2 = _interopRequireDefault(_getExports);

var _importDeclaration = require('../importDeclaration');

var _importDeclaration2 = _interopRequireDefault(_importDeclaration);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

//------------------------------------------------------------------------------
// Rule Definition
//------------------------------------------------------------------------------

module.exports = function (context) {

  var fileImports = new _es6Map2.default();
  var allPropertyLookups = new _es6Map2.default();

  function handleImportDefault(node) {
    var declaration = (0, _importDeclaration2.default)(context);
    var exportMap = _getExports2.default.get(declaration.source.value, context);
    if (exportMap == null) return;

    if (exportMap.errors.length) {
      exportMap.reportErrors(context, declaration);
      return;
    }

    fileImports.set(node.local.name, {
      exportMap: exportMap,
      sourcePath: declaration.source.value
    });
  }

  function storePropertyLookup(objectName, propName, node) {
    var lookups = allPropertyLookups.get(objectName) || [];
    lookups.push({ node: node, propName: propName });
    allPropertyLookups.set(objectName, lookups);
  }

  function handlePropLookup(node) {
    var objectName = node.object.name;
    var propName = node.property.name;
    storePropertyLookup(objectName, propName, node);
  }

  function handleDestructuringAssignment(node) {
    var isDestructure = node.id.type === 'ObjectPattern' && node.init != null && node.init.type === 'Identifier';
    if (!isDestructure) return;

    var objectName = node.init.name;
    node.id.properties.forEach(function (_ref) {
      var key = _ref.key;

      if (key != null) {
        // rest properties are null
        storePropertyLookup(objectName, key.name, key);
      }
    });
  }

  function handleProgramExit() {
    allPropertyLookups.forEach(function (lookups, objectName) {
      var fileImport = fileImports.get(objectName);
      if (fileImport == null) return;

      lookups.forEach(function (_ref2) {
        var propName = _ref2.propName;
        var node = _ref2.node;

        if (fileImport.exportMap.namespace.has(propName)) {
          context.report({
            node: node,
            message: 'Caution: `' + objectName + '` also has a named export ' + ('`' + propName + '`. Check if you meant to write ') + ('`import {' + propName + '} from \'' + fileImport.sourcePath + '\'` ') + 'instead.'
          });
        }
      });
    });
  }

  return {
    'ImportDefaultSpecifier': handleImportDefault,
    'MemberExpression': handlePropLookup,
    'VariableDeclarator': handleDestructuringAssignment,
    'Program:exit': handleProgramExit
  };
}; /**
    * @fileoverview Rule to warn about potentially confused use of name exports
    * @author Desmond Brand
    * @copyright 2016 Desmond Brand. All rights reserved.
    * See LICENSE in root directory for full license.
    */
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInJ1bGVzL25vLW5hbWVkLWFzLWRlZmF1bHQtbWVtYmVyLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBT0E7Ozs7QUFFQTs7OztBQUNBOzs7Ozs7Ozs7O0FBTUEsT0FBTyxPQUFQLEdBQWlCLFVBQVMsT0FBVCxFQUFrQjs7QUFFakMsTUFBTSxjQUFjLHNCQUFwQjtBQUNBLE1BQU0scUJBQXFCLHNCQUEzQjs7QUFFQSxXQUFTLG1CQUFULENBQTZCLElBQTdCLEVBQW1DO0FBQ2pDLFFBQU0sY0FBYyxpQ0FBa0IsT0FBbEIsQ0FBcEI7QUFDQSxRQUFNLFlBQVkscUJBQVEsR0FBUixDQUFZLFlBQVksTUFBWixDQUFtQixLQUEvQixFQUFzQyxPQUF0QyxDQUFsQjtBQUNBLFFBQUksYUFBYSxJQUFqQixFQUF1Qjs7QUFFdkIsUUFBSSxVQUFVLE1BQVYsQ0FBaUIsTUFBckIsRUFBNkI7QUFDM0IsZ0JBQVUsWUFBVixDQUF1QixPQUF2QixFQUFnQyxXQUFoQztBQUNBO0FBQ0Q7O0FBRUQsZ0JBQVksR0FBWixDQUFnQixLQUFLLEtBQUwsQ0FBVyxJQUEzQixFQUFpQztBQUMvQiwwQkFEK0I7QUFFL0Isa0JBQVksWUFBWSxNQUFaLENBQW1CO0FBRkEsS0FBakM7QUFJRDs7QUFFRCxXQUFTLG1CQUFULENBQTZCLFVBQTdCLEVBQXlDLFFBQXpDLEVBQW1ELElBQW5ELEVBQXlEO0FBQ3ZELFFBQU0sVUFBVSxtQkFBbUIsR0FBbkIsQ0FBdUIsVUFBdkIsS0FBc0MsRUFBdEQ7QUFDQSxZQUFRLElBQVIsQ0FBYSxFQUFDLFVBQUQsRUFBTyxrQkFBUCxFQUFiO0FBQ0EsdUJBQW1CLEdBQW5CLENBQXVCLFVBQXZCLEVBQW1DLE9BQW5DO0FBQ0Q7O0FBRUQsV0FBUyxnQkFBVCxDQUEwQixJQUExQixFQUFnQztBQUM5QixRQUFNLGFBQWEsS0FBSyxNQUFMLENBQVksSUFBL0I7QUFDQSxRQUFNLFdBQVcsS0FBSyxRQUFMLENBQWMsSUFBL0I7QUFDQSx3QkFBb0IsVUFBcEIsRUFBZ0MsUUFBaEMsRUFBMEMsSUFBMUM7QUFDRDs7QUFFRCxXQUFTLDZCQUFULENBQXVDLElBQXZDLEVBQTZDO0FBQzNDLFFBQU0sZ0JBQ0osS0FBSyxFQUFMLENBQVEsSUFBUixLQUFpQixlQUFqQixJQUNBLEtBQUssSUFBTCxJQUFhLElBRGIsSUFFQSxLQUFLLElBQUwsQ0FBVSxJQUFWLEtBQW1CLFlBSHJCO0FBS0EsUUFBSSxDQUFDLGFBQUwsRUFBb0I7O0FBRXBCLFFBQU0sYUFBYSxLQUFLLElBQUwsQ0FBVSxJQUE3QjtBQUNBLFNBQUssRUFBTCxDQUFRLFVBQVIsQ0FBbUIsT0FBbkIsQ0FBMkIsZ0JBQVc7QUFBQSxVQUFULEdBQVMsUUFBVCxHQUFTOztBQUNwQyxVQUFJLE9BQU8sSUFBWCxFQUFpQjs7QUFDZiw0QkFBb0IsVUFBcEIsRUFBZ0MsSUFBSSxJQUFwQyxFQUEwQyxHQUExQztBQUNEO0FBQ0YsS0FKRDtBQUtEOztBQUVELFdBQVMsaUJBQVQsR0FBNkI7QUFDM0IsdUJBQW1CLE9BQW5CLENBQTJCLFVBQUMsT0FBRCxFQUFVLFVBQVYsRUFBeUI7QUFDbEQsVUFBTSxhQUFhLFlBQVksR0FBWixDQUFnQixVQUFoQixDQUFuQjtBQUNBLFVBQUksY0FBYyxJQUFsQixFQUF3Qjs7QUFFeEIsY0FBUSxPQUFSLENBQWdCLGlCQUFzQjtBQUFBLFlBQXBCLFFBQW9CLFNBQXBCLFFBQW9CO0FBQUEsWUFBVixJQUFVLFNBQVYsSUFBVTs7QUFDcEMsWUFBSSxXQUFXLFNBQVgsQ0FBcUIsU0FBckIsQ0FBK0IsR0FBL0IsQ0FBbUMsUUFBbkMsQ0FBSixFQUFrRDtBQUNoRCxrQkFBUSxNQUFSLENBQWU7QUFDYixzQkFEYTtBQUViLHFCQUNFLGVBQWMsVUFBZCx5Q0FDSyxRQURMLHVEQUVhLFFBRmIsaUJBRWdDLFdBQVcsVUFGM0MsYUFHQTtBQU5XLFdBQWY7QUFTRDtBQUNGLE9BWkQ7QUFhRCxLQWpCRDtBQWtCRDs7QUFFRCxTQUFPO0FBQ0wsOEJBQTBCLG1CQURyQjtBQUVMLHdCQUFvQixnQkFGZjtBQUdMLDBCQUFzQiw2QkFIakI7QUFJTCxvQkFBZ0I7QUFKWCxHQUFQO0FBTUQsQ0E1RUQsQyIsImZpbGUiOiJydWxlcy9uby1uYW1lZC1hcy1kZWZhdWx0LW1lbWJlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQGZpbGVvdmVydmlldyBSdWxlIHRvIHdhcm4gYWJvdXQgcG90ZW50aWFsbHkgY29uZnVzZWQgdXNlIG9mIG5hbWUgZXhwb3J0c1xuICogQGF1dGhvciBEZXNtb25kIEJyYW5kXG4gKiBAY29weXJpZ2h0IDIwMTYgRGVzbW9uZCBCcmFuZC4gQWxsIHJpZ2h0cyByZXNlcnZlZC5cbiAqIFNlZSBMSUNFTlNFIGluIHJvb3QgZGlyZWN0b3J5IGZvciBmdWxsIGxpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IE1hcCBmcm9tICdlczYtbWFwJ1xuXG5pbXBvcnQgRXhwb3J0cyBmcm9tICcuLi9jb3JlL2dldEV4cG9ydHMnXG5pbXBvcnQgaW1wb3J0RGVjbGFyYXRpb24gZnJvbSAnLi4vaW1wb3J0RGVjbGFyYXRpb24nXG5cbi8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4vLyBSdWxlIERlZmluaXRpb25cbi8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG5cbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oY29udGV4dCkge1xuXG4gIGNvbnN0IGZpbGVJbXBvcnRzID0gbmV3IE1hcCgpXG4gIGNvbnN0IGFsbFByb3BlcnR5TG9va3VwcyA9IG5ldyBNYXAoKVxuXG4gIGZ1bmN0aW9uIGhhbmRsZUltcG9ydERlZmF1bHQobm9kZSkge1xuICAgIGNvbnN0IGRlY2xhcmF0aW9uID0gaW1wb3J0RGVjbGFyYXRpb24oY29udGV4dClcbiAgICBjb25zdCBleHBvcnRNYXAgPSBFeHBvcnRzLmdldChkZWNsYXJhdGlvbi5zb3VyY2UudmFsdWUsIGNvbnRleHQpXG4gICAgaWYgKGV4cG9ydE1hcCA9PSBudWxsKSByZXR1cm5cblxuICAgIGlmIChleHBvcnRNYXAuZXJyb3JzLmxlbmd0aCkge1xuICAgICAgZXhwb3J0TWFwLnJlcG9ydEVycm9ycyhjb250ZXh0LCBkZWNsYXJhdGlvbilcbiAgICAgIHJldHVyblxuICAgIH1cblxuICAgIGZpbGVJbXBvcnRzLnNldChub2RlLmxvY2FsLm5hbWUsIHtcbiAgICAgIGV4cG9ydE1hcCxcbiAgICAgIHNvdXJjZVBhdGg6IGRlY2xhcmF0aW9uLnNvdXJjZS52YWx1ZSxcbiAgICB9KVxuICB9XG5cbiAgZnVuY3Rpb24gc3RvcmVQcm9wZXJ0eUxvb2t1cChvYmplY3ROYW1lLCBwcm9wTmFtZSwgbm9kZSkge1xuICAgIGNvbnN0IGxvb2t1cHMgPSBhbGxQcm9wZXJ0eUxvb2t1cHMuZ2V0KG9iamVjdE5hbWUpIHx8IFtdXG4gICAgbG9va3Vwcy5wdXNoKHtub2RlLCBwcm9wTmFtZX0pXG4gICAgYWxsUHJvcGVydHlMb29rdXBzLnNldChvYmplY3ROYW1lLCBsb29rdXBzKVxuICB9XG5cbiAgZnVuY3Rpb24gaGFuZGxlUHJvcExvb2t1cChub2RlKSB7XG4gICAgY29uc3Qgb2JqZWN0TmFtZSA9IG5vZGUub2JqZWN0Lm5hbWVcbiAgICBjb25zdCBwcm9wTmFtZSA9IG5vZGUucHJvcGVydHkubmFtZVxuICAgIHN0b3JlUHJvcGVydHlMb29rdXAob2JqZWN0TmFtZSwgcHJvcE5hbWUsIG5vZGUpXG4gIH1cblxuICBmdW5jdGlvbiBoYW5kbGVEZXN0cnVjdHVyaW5nQXNzaWdubWVudChub2RlKSB7XG4gICAgY29uc3QgaXNEZXN0cnVjdHVyZSA9IChcbiAgICAgIG5vZGUuaWQudHlwZSA9PT0gJ09iamVjdFBhdHRlcm4nICYmXG4gICAgICBub2RlLmluaXQgIT0gbnVsbCAmJlxuICAgICAgbm9kZS5pbml0LnR5cGUgPT09ICdJZGVudGlmaWVyJ1xuICAgIClcbiAgICBpZiAoIWlzRGVzdHJ1Y3R1cmUpIHJldHVyblxuXG4gICAgY29uc3Qgb2JqZWN0TmFtZSA9IG5vZGUuaW5pdC5uYW1lXG4gICAgbm9kZS5pZC5wcm9wZXJ0aWVzLmZvckVhY2goKHtrZXl9KSA9PiB7XG4gICAgICBpZiAoa2V5ICE9IG51bGwpIHsgLy8gcmVzdCBwcm9wZXJ0aWVzIGFyZSBudWxsXG4gICAgICAgIHN0b3JlUHJvcGVydHlMb29rdXAob2JqZWN0TmFtZSwga2V5Lm5hbWUsIGtleSlcbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbiAgZnVuY3Rpb24gaGFuZGxlUHJvZ3JhbUV4aXQoKSB7XG4gICAgYWxsUHJvcGVydHlMb29rdXBzLmZvckVhY2goKGxvb2t1cHMsIG9iamVjdE5hbWUpID0+IHtcbiAgICAgIGNvbnN0IGZpbGVJbXBvcnQgPSBmaWxlSW1wb3J0cy5nZXQob2JqZWN0TmFtZSlcbiAgICAgIGlmIChmaWxlSW1wb3J0ID09IG51bGwpIHJldHVyblxuXG4gICAgICBsb29rdXBzLmZvckVhY2goKHtwcm9wTmFtZSwgbm9kZX0pID0+IHtcbiAgICAgICAgaWYgKGZpbGVJbXBvcnQuZXhwb3J0TWFwLm5hbWVzcGFjZS5oYXMocHJvcE5hbWUpKSB7XG4gICAgICAgICAgY29udGV4dC5yZXBvcnQoe1xuICAgICAgICAgICAgbm9kZSxcbiAgICAgICAgICAgIG1lc3NhZ2U6IChcbiAgICAgICAgICAgICAgYENhdXRpb246IFxcYCR7b2JqZWN0TmFtZX1cXGAgYWxzbyBoYXMgYSBuYW1lZCBleHBvcnQgYCArXG4gICAgICAgICAgICAgIGBcXGAke3Byb3BOYW1lfVxcYC4gQ2hlY2sgaWYgeW91IG1lYW50IHRvIHdyaXRlIGAgK1xuICAgICAgICAgICAgICBgXFxgaW1wb3J0IHske3Byb3BOYW1lfX0gZnJvbSAnJHtmaWxlSW1wb3J0LnNvdXJjZVBhdGh9J1xcYCBgICtcbiAgICAgICAgICAgICAgJ2luc3RlYWQuJ1xuICAgICAgICAgICAgKSxcbiAgICAgICAgICB9KVxuICAgICAgICB9XG4gICAgICB9KVxuICAgIH0pXG4gIH1cblxuICByZXR1cm4ge1xuICAgICdJbXBvcnREZWZhdWx0U3BlY2lmaWVyJzogaGFuZGxlSW1wb3J0RGVmYXVsdCxcbiAgICAnTWVtYmVyRXhwcmVzc2lvbic6IGhhbmRsZVByb3BMb29rdXAsXG4gICAgJ1ZhcmlhYmxlRGVjbGFyYXRvcic6IGhhbmRsZURlc3RydWN0dXJpbmdBc3NpZ25tZW50LFxuICAgICdQcm9ncmFtOmV4aXQnOiBoYW5kbGVQcm9ncmFtRXhpdCxcbiAgfVxufVxuIl19