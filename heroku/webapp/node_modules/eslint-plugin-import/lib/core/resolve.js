'use strict';

exports.__esModule = true;
exports.CASE_SENSITIVE_FS = undefined;

var _typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) { return typeof obj; } : function (obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol ? "symbol" : typeof obj; };

exports.relative = relative;
exports.default = resolve;

var _es6Map = require('es6-map');

var _es6Map2 = _interopRequireDefault(_es6Map);

var _es6Set = require('es6-set');

var _es6Set2 = _interopRequireDefault(_es6Set);

var _objectAssign = require('object-assign');

var _objectAssign2 = _interopRequireDefault(_objectAssign);

var _pkgDir = require('pkg-dir');

var _pkgDir2 = _interopRequireDefault(_pkgDir);

var _fs = require('fs');

var _fs2 = _interopRequireDefault(_fs);

var _path = require('path');

var path = _interopRequireWildcard(_path);

var _crypto = require('crypto');

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var CASE_SENSITIVE_FS = exports.CASE_SENSITIVE_FS = !_fs2.default.existsSync(path.join(__dirname, 'reSOLVE.js'));

var fileExistsCache = new _es6Map2.default();

function cachePath(cacheKey, result) {
  fileExistsCache.set(cacheKey, { result: result, lastSeen: Date.now() });
}

function checkCache(cacheKey, _ref) {
  var lifetime = _ref.lifetime;

  if (fileExistsCache.has(cacheKey)) {
    var _fileExistsCache$get = fileExistsCache.get(cacheKey);

    var result = _fileExistsCache$get.result;
    var lastSeen = _fileExistsCache$get.lastSeen;
    // check fresness

    if (Date.now() - lastSeen < lifetime * 1000) return result;
  }
  // cache miss
  return undefined;
}

// http://stackoverflow.com/a/27382838
function fileExistsWithCaseSync(filepath, cacheSettings) {
  // don't care if the FS is case-sensitive
  if (CASE_SENSITIVE_FS) return true;

  // null means it resolved to a builtin
  if (filepath === null) return true;

  var dir = path.dirname(filepath);

  var result = checkCache(filepath, cacheSettings);
  if (result != null) return result;

  // base case
  if (dir === '/' || dir === '.' || /^[A-Z]:\\$/i.test(dir)) {
    result = true;
  } else {
    var filenames = _fs2.default.readdirSync(dir);
    if (filenames.indexOf(path.basename(filepath)) === -1) {
      result = false;
    } else {
      result = fileExistsWithCaseSync(dir, cacheSettings);
    }
  }
  cachePath(filepath, result);
  return result;
}

function relative(modulePath, sourceFile, settings) {
  return fullResolve(modulePath, sourceFile, settings).path;
}

function fullResolve(modulePath, sourceFile, settings) {
  // check if this is a bonus core module
  var coreSet = new _es6Set2.default(settings['import/core-modules']);
  if (coreSet != null && coreSet.has(modulePath)) return { found: true, path: null };

  var sourceDir = path.dirname(sourceFile),
      cacheKey = sourceDir + hashObject(settings) + modulePath;

  var cacheSettings = (0, _objectAssign2.default)({
    lifetime: 30 }, settings['import/cache']);

  // parse infinity
  if (cacheSettings.lifetime === 'âˆž' || cacheSettings.lifetime === 'Infinity') {
    cacheSettings.lifetime = Infinity;
  }

  var cachedPath = checkCache(cacheKey, cacheSettings);
  if (cachedPath !== undefined) return { found: true, path: cachedPath };

  function cache(resolvedPath) {
    cachePath(cacheKey, resolvedPath);
  }

  function withResolver(resolver, config) {

    function v1() {
      try {
        var _resolved = resolver.resolveImport(modulePath, sourceFile, config);
        if (_resolved === undefined) return { found: false };
        return { found: true, path: _resolved };
      } catch (err) {
        return { found: false };
      }
    }

    function v2() {
      return resolver.resolve(modulePath, sourceFile, config);
    }

    switch (resolver.interfaceVersion) {
      case 2:
        return v2();

      default:
      case 1:
        return v1();
    }
  }

  var configResolvers = settings['import/resolver'] || { 'node': settings['import/resolve'] }; // backward compatibility

  var resolvers = resolverReducer(configResolvers, new _es6Map2.default());

  var resolved = { found: false };
  resolvers.forEach(function (config, name) {
    if (!resolved.found) {
      var resolver = requireResolver(name, sourceFile);
      resolved = withResolver(resolver, config);
      if (resolved.found) {
        // resolvers imply file existence, this double-check just ensures the case matches
        if (fileExistsWithCaseSync(resolved.path, cacheSettings)) {
          // else, counts
          cache(resolved.path);
        } else {
          resolved = { found: false };
        }
      }
    }
  });

  return resolved;
}

function resolverReducer(resolvers, map) {
  if (resolvers instanceof Array) {
    resolvers.forEach(function (r) {
      return resolverReducer(r, map);
    });
    return map;
  }

  if (typeof resolvers === 'string') {
    map.set(resolvers, null);
    return map;
  }

  if ((typeof resolvers === 'undefined' ? 'undefined' : _typeof(resolvers)) === 'object') {
    for (var key in resolvers) {
      map.set(key, resolvers[key]);
    }
    return map;
  }

  throw new Error('invalid resolver config');
}

function requireResolver(name, sourceFile) {
  // Try to resolve package with conventional name
  try {
    return require('eslint-import-resolver-' + name);
  } catch (err) {} /* continue */

  // Try to resolve package with custom name (@myorg/resolver-name)
  try {
    return require(name);
  } catch (err) {} /* continue */

  // Try to resolve package with path, relative to closest package.json
  // or current working directory
  try {
    var baseDir = _pkgDir2.default.sync(sourceFile) || process.cwd();
    // absolute paths ignore base, so this covers both
    return require(path.resolve(baseDir, name));
  } catch (err) {} /* continue */

  // all else failed
  throw new Error('unable to load resolver "' + name + '".');
}

var erroredContexts = new _es6Set2.default();

/**
 * Given
 * @param  {string} p - module path
 * @param  {object} context - ESLint context
 * @return {string} - the full module filesystem path;
 *                    null if package is core;
 *                    undefined if not found
 */
function resolve(p, context) {
  try {
    return relative(p, context.getFilename(), context.settings);
  } catch (err) {
    if (!erroredContexts.has(context)) {
      context.report({
        message: 'Resolve error: ' + err.message,
        loc: { line: 1, col: 0 }
      });
      erroredContexts.add(context);
    }
  }
}
resolve.relative = relative;

function hashObject(object) {
  var settingsShasum = (0, _crypto.createHash)('sha1');
  settingsShasum.update(JSON.stringify(object));
  return settingsShasum.digest('hex');
}
//# sourceMappingURL=data:application/json;base64,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QXNCLEtBQXRCLENBQVA7QUFDRCIsImZpbGUiOiJjb3JlL3Jlc29sdmUuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgTWFwIGZyb20gJ2VzNi1tYXAnXG5pbXBvcnQgU2V0IGZyb20gJ2VzNi1zZXQnXG5pbXBvcnQgYXNzaWduIGZyb20gJ29iamVjdC1hc3NpZ24nXG5pbXBvcnQgcGtnRGlyIGZyb20gJ3BrZy1kaXInXG5cbmltcG9ydCBmcyBmcm9tICdmcydcbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCdcblxuZXhwb3J0IGNvbnN0IENBU0VfU0VOU0lUSVZFX0ZTID0gIWZzLmV4aXN0c1N5bmMocGF0aC5qb2luKF9fZGlybmFtZSwgJ3JlU09MVkUuanMnKSlcblxuY29uc3QgZmlsZUV4aXN0c0NhY2hlID0gbmV3IE1hcCgpXG5cbmZ1bmN0aW9uIGNhY2hlUGF0aChjYWNoZUtleSwgcmVzdWx0KSB7XG4gIGZpbGVFeGlzdHNDYWNoZS5zZXQoY2FjaGVLZXksIHsgcmVzdWx0LCBsYXN0U2VlbjogRGF0ZS5ub3coKSB9KVxufVxuXG5mdW5jdGlvbiBjaGVja0NhY2hlKGNhY2hlS2V5LCB7IGxpZmV0aW1lIH0pIHtcbiAgaWYgKGZpbGVFeGlzdHNDYWNoZS5oYXMoY2FjaGVLZXkpKSB7XG4gICAgY29uc3QgeyByZXN1bHQsIGxhc3RTZWVuIH0gPSBmaWxlRXhpc3RzQ2FjaGUuZ2V0KGNhY2hlS2V5KVxuICAgIC8vIGNoZWNrIGZyZXNuZXNzXG4gICAgaWYgKERhdGUubm93KCkgLSBsYXN0U2VlbiA8IChsaWZldGltZSAqIDEwMDApKSByZXR1cm4gcmVzdWx0XG4gIH1cbiAgLy8gY2FjaGUgbWlzc1xuICByZXR1cm4gdW5kZWZpbmVkXG59XG5cbi8vIGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9hLzI3MzgyODM4XG5mdW5jdGlvbiBmaWxlRXhpc3RzV2l0aENhc2VTeW5jKGZpbGVwYXRoLCBjYWNoZVNldHRpbmdzKSB7XG4gIC8vIGRvbid0IGNhcmUgaWYgdGhlIEZTIGlzIGNhc2Utc2Vuc2l0aXZlXG4gIGlmIChDQVNFX1NFTlNJVElWRV9GUykgcmV0dXJuIHRydWVcblxuICAvLyBudWxsIG1lYW5zIGl0IHJlc29sdmVkIHRvIGEgYnVpbHRpblxuICBpZiAoZmlsZXBhdGggPT09IG51bGwpIHJldHVybiB0cnVlXG5cbiAgY29uc3QgZGlyID0gcGF0aC5kaXJuYW1lKGZpbGVwYXRoKVxuXG4gIGxldCByZXN1bHQgPSBjaGVja0NhY2hlKGZpbGVwYXRoLCBjYWNoZVNldHRpbmdzKVxuICBpZiAocmVzdWx0ICE9IG51bGwpIHJldHVybiByZXN1bHRcblxuICAvLyBiYXNlIGNhc2VcbiAgaWYgKGRpciA9PT0gJy8nIHx8IGRpciA9PT0gJy4nIHx8IC9eW0EtWl06XFxcXCQvaS50ZXN0KGRpcikpIHtcbiAgICByZXN1bHQgPSB0cnVlXG4gIH0gZWxzZSB7XG4gICAgY29uc3QgZmlsZW5hbWVzID0gZnMucmVhZGRpclN5bmMoZGlyKVxuICAgIGlmIChmaWxlbmFtZXMuaW5kZXhPZihwYXRoLmJhc2VuYW1lKGZpbGVwYXRoKSkgPT09IC0xKSB7XG4gICAgICByZXN1bHQgPSBmYWxzZVxuICAgIH0gZWxzZSB7XG4gICAgICByZXN1bHQgPSBmaWxlRXhpc3RzV2l0aENhc2VTeW5jKGRpciwgY2FjaGVTZXR0aW5ncylcbiAgICB9XG4gIH1cbiAgY2FjaGVQYXRoKGZpbGVwYXRoLCByZXN1bHQpXG4gIHJldHVybiByZXN1bHRcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHJlbGF0aXZlKG1vZHVsZVBhdGgsIHNvdXJjZUZpbGUsIHNldHRpbmdzKSB7XG4gIHJldHVybiBmdWxsUmVzb2x2ZShtb2R1bGVQYXRoLCBzb3VyY2VGaWxlLCBzZXR0aW5ncykucGF0aFxufVxuXG5mdW5jdGlvbiBmdWxsUmVzb2x2ZShtb2R1bGVQYXRoLCBzb3VyY2VGaWxlLCBzZXR0aW5ncykge1xuICAvLyBjaGVjayBpZiB0aGlzIGlzIGEgYm9udXMgY29yZSBtb2R1bGVcbiAgY29uc3QgY29yZVNldCA9IG5ldyBTZXQoc2V0dGluZ3NbJ2ltcG9ydC9jb3JlLW1vZHVsZXMnXSlcbiAgaWYgKGNvcmVTZXQgIT0gbnVsbCAmJiBjb3JlU2V0Lmhhcyhtb2R1bGVQYXRoKSkgcmV0dXJuIHsgZm91bmQ6IHRydWUsIHBhdGg6IG51bGwgfVxuXG4gIGNvbnN0IHNvdXJjZURpciA9IHBhdGguZGlybmFtZShzb3VyY2VGaWxlKVxuICAgICAgLCBjYWNoZUtleSA9IHNvdXJjZURpciArIGhhc2hPYmplY3Qoc2V0dGluZ3MpICsgbW9kdWxlUGF0aFxuXG4gIGNvbnN0IGNhY2hlU2V0dGluZ3MgPSBhc3NpZ24oe1xuICAgIGxpZmV0aW1lOiAzMCwgIC8vIHNlY29uZHNcbiAgfSwgc2V0dGluZ3NbJ2ltcG9ydC9jYWNoZSddKVxuXG4gIC8vIHBhcnNlIGluZmluaXR5XG4gIGlmIChjYWNoZVNldHRpbmdzLmxpZmV0aW1lID09PSAn4oieJyB8fCBjYWNoZVNldHRpbmdzLmxpZmV0aW1lID09PSAnSW5maW5pdHknKSB7XG4gICAgY2FjaGVTZXR0aW5ncy5saWZldGltZSA9IEluZmluaXR5XG4gIH1cblxuICBjb25zdCBjYWNoZWRQYXRoID0gY2hlY2tDYWNoZShjYWNoZUtleSwgY2FjaGVTZXR0aW5ncylcbiAgaWYgKGNhY2hlZFBhdGggIT09IHVuZGVmaW5lZCkgcmV0dXJuIHsgZm91bmQ6IHRydWUsIHBhdGg6IGNhY2hlZFBhdGggfVxuXG4gIGZ1bmN0aW9uIGNhY2hlKHJlc29sdmVkUGF0aCkge1xuICAgIGNhY2hlUGF0aChjYWNoZUtleSwgcmVzb2x2ZWRQYXRoKVxuICB9XG5cbiAgZnVuY3Rpb24gd2l0aFJlc29sdmVyKHJlc29sdmVyLCBjb25maWcpIHtcblxuICAgIGZ1bmN0aW9uIHYxKCkge1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgcmVzb2x2ZWQgPSByZXNvbHZlci5yZXNvbHZlSW1wb3J0KG1vZHVsZVBhdGgsIHNvdXJjZUZpbGUsIGNvbmZpZylcbiAgICAgICAgaWYgKHJlc29sdmVkID09PSB1bmRlZmluZWQpIHJldHVybiB7IGZvdW5kOiBmYWxzZSB9XG4gICAgICAgIHJldHVybiB7IGZvdW5kOiB0cnVlLCBwYXRoOiByZXNvbHZlZCB9XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgcmV0dXJuIHsgZm91bmQ6IGZhbHNlIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICBmdW5jdGlvbiB2MigpIHtcbiAgICAgIHJldHVybiByZXNvbHZlci5yZXNvbHZlKG1vZHVsZVBhdGgsIHNvdXJjZUZpbGUsIGNvbmZpZylcbiAgICB9XG5cbiAgICBzd2l0Y2ggKHJlc29sdmVyLmludGVyZmFjZVZlcnNpb24pIHtcbiAgICAgIGNhc2UgMjpcbiAgICAgICAgcmV0dXJuIHYyKClcblxuICAgICAgZGVmYXVsdDpcbiAgICAgIGNhc2UgMTpcbiAgICAgICAgcmV0dXJuIHYxKClcbiAgICB9XG4gIH1cblxuICBjb25zdCBjb25maWdSZXNvbHZlcnMgPSAoc2V0dGluZ3NbJ2ltcG9ydC9yZXNvbHZlciddXG4gICAgfHwgeyAnbm9kZSc6IHNldHRpbmdzWydpbXBvcnQvcmVzb2x2ZSddIH0pIC8vIGJhY2t3YXJkIGNvbXBhdGliaWxpdHlcblxuICBjb25zdCByZXNvbHZlcnMgPSByZXNvbHZlclJlZHVjZXIoY29uZmlnUmVzb2x2ZXJzLCBuZXcgTWFwKCkpXG5cbiAgbGV0IHJlc29sdmVkID0geyBmb3VuZDogZmFsc2UgfVxuICByZXNvbHZlcnMuZm9yRWFjaChmdW5jdGlvbiAoY29uZmlnLCBuYW1lKSAge1xuICAgIGlmICghcmVzb2x2ZWQuZm91bmQpIHtcbiAgICAgIGNvbnN0IHJlc29sdmVyID0gcmVxdWlyZVJlc29sdmVyKG5hbWUsIHNvdXJjZUZpbGUpXG4gICAgICByZXNvbHZlZCA9IHdpdGhSZXNvbHZlcihyZXNvbHZlciwgY29uZmlnKVxuICAgICAgaWYgKHJlc29sdmVkLmZvdW5kKSB7XG4gICAgICAgIC8vIHJlc29sdmVycyBpbXBseSBmaWxlIGV4aXN0ZW5jZSwgdGhpcyBkb3VibGUtY2hlY2sganVzdCBlbnN1cmVzIHRoZSBjYXNlIG1hdGNoZXNcbiAgICAgICAgaWYgKGZpbGVFeGlzdHNXaXRoQ2FzZVN5bmMocmVzb2x2ZWQucGF0aCwgY2FjaGVTZXR0aW5ncykpIHtcbiAgICAgICAgICAvLyBlbHNlLCBjb3VudHNcbiAgICAgICAgICBjYWNoZShyZXNvbHZlZC5wYXRoKVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJlc29sdmVkID0geyBmb3VuZDogZmFsc2UgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9KVxuXG4gIHJldHVybiByZXNvbHZlZFxufVxuXG5mdW5jdGlvbiByZXNvbHZlclJlZHVjZXIocmVzb2x2ZXJzLCBtYXApIHtcbiAgaWYgKHJlc29sdmVycyBpbnN0YW5jZW9mIEFycmF5KSB7XG4gICAgcmVzb2x2ZXJzLmZvckVhY2gociA9PiByZXNvbHZlclJlZHVjZXIociwgbWFwKSlcbiAgICByZXR1cm4gbWFwXG4gIH1cblxuICBpZiAodHlwZW9mIHJlc29sdmVycyA9PT0gJ3N0cmluZycpIHtcbiAgICBtYXAuc2V0KHJlc29sdmVycywgbnVsbClcbiAgICByZXR1cm4gbWFwXG4gIH1cblxuICBpZiAodHlwZW9mIHJlc29sdmVycyA9PT0gJ29iamVjdCcpIHtcbiAgICBmb3IgKGxldCBrZXkgaW4gcmVzb2x2ZXJzKSB7XG4gICAgICBtYXAuc2V0KGtleSwgcmVzb2x2ZXJzW2tleV0pXG4gICAgfVxuICAgIHJldHVybiBtYXBcbiAgfVxuXG4gIHRocm93IG5ldyBFcnJvcignaW52YWxpZCByZXNvbHZlciBjb25maWcnKVxufVxuXG5mdW5jdGlvbiByZXF1aXJlUmVzb2x2ZXIobmFtZSwgc291cmNlRmlsZSkge1xuICAvLyBUcnkgdG8gcmVzb2x2ZSBwYWNrYWdlIHdpdGggY29udmVudGlvbmFsIG5hbWVcbiAgdHJ5IHtcbiAgICByZXR1cm4gcmVxdWlyZShgZXNsaW50LWltcG9ydC1yZXNvbHZlci0ke25hbWV9YClcbiAgfSBjYXRjaCAoZXJyKSB7IC8qIGNvbnRpbnVlICovIH1cblxuICAvLyBUcnkgdG8gcmVzb2x2ZSBwYWNrYWdlIHdpdGggY3VzdG9tIG5hbWUgKEBteW9yZy9yZXNvbHZlci1uYW1lKVxuICB0cnkge1xuICAgIHJldHVybiByZXF1aXJlKG5hbWUpXG4gIH0gY2F0Y2ggKGVycikgeyAvKiBjb250aW51ZSAqLyB9XG5cbiAgLy8gVHJ5IHRvIHJlc29sdmUgcGFja2FnZSB3aXRoIHBhdGgsIHJlbGF0aXZlIHRvIGNsb3Nlc3QgcGFja2FnZS5qc29uXG4gIC8vIG9yIGN1cnJlbnQgd29ya2luZyBkaXJlY3RvcnlcbiAgdHJ5IHtcbiAgICBjb25zdCBiYXNlRGlyID0gcGtnRGlyLnN5bmMoc291cmNlRmlsZSkgfHwgcHJvY2Vzcy5jd2QoKVxuICAgIC8vIGFic29sdXRlIHBhdGhzIGlnbm9yZSBiYXNlLCBzbyB0aGlzIGNvdmVycyBib3RoXG4gICAgcmV0dXJuIHJlcXVpcmUocGF0aC5yZXNvbHZlKGJhc2VEaXIsIG5hbWUpKVxuICB9IGNhdGNoIChlcnIpIHsgLyogY29udGludWUgKi8gfVxuXG4gIC8vIGFsbCBlbHNlIGZhaWxlZFxuICB0aHJvdyBuZXcgRXJyb3IoYHVuYWJsZSB0byBsb2FkIHJlc29sdmVyIFwiJHtuYW1lfVwiLmApXG59XG5cbmNvbnN0IGVycm9yZWRDb250ZXh0cyA9IG5ldyBTZXQoKVxuXG4vKipcbiAqIEdpdmVuXG4gKiBAcGFyYW0gIHtzdHJpbmd9IHAgLSBtb2R1bGUgcGF0aFxuICogQHBhcmFtICB7b2JqZWN0fSBjb250ZXh0IC0gRVNMaW50IGNvbnRleHRcbiAqIEByZXR1cm4ge3N0cmluZ30gLSB0aGUgZnVsbCBtb2R1bGUgZmlsZXN5c3RlbSBwYXRoO1xuICogICAgICAgICAgICAgICAgICAgIG51bGwgaWYgcGFja2FnZSBpcyBjb3JlO1xuICogICAgICAgICAgICAgICAgICAgIHVuZGVmaW5lZCBpZiBub3QgZm91bmRcbiAqL1xuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gcmVzb2x2ZShwLCBjb250ZXh0KSB7XG4gIHRyeSB7XG4gICAgcmV0dXJuIHJlbGF0aXZlKCBwXG4gICAgICAgICAgICAgICAgICAgLCBjb250ZXh0LmdldEZpbGVuYW1lKClcbiAgICAgICAgICAgICAgICAgICAsIGNvbnRleHQuc2V0dGluZ3NcbiAgICAgICAgICAgICAgICAgICApXG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGlmICghZXJyb3JlZENvbnRleHRzLmhhcyhjb250ZXh0KSkge1xuICAgICAgY29udGV4dC5yZXBvcnQoe1xuICAgICAgICBtZXNzYWdlOiBgUmVzb2x2ZSBlcnJvcjogJHtlcnIubWVzc2FnZX1gLFxuICAgICAgICBsb2M6IHsgbGluZTogMSwgY29sOiAwIH0sXG4gICAgICB9KVxuICAgICAgZXJyb3JlZENvbnRleHRzLmFkZChjb250ZXh0KVxuICAgIH1cbiAgfVxufVxucmVzb2x2ZS5yZWxhdGl2ZSA9IHJlbGF0aXZlXG5cblxuaW1wb3J0IHsgY3JlYXRlSGFzaCB9IGZyb20gJ2NyeXB0bydcbmZ1bmN0aW9uIGhhc2hPYmplY3Qob2JqZWN0KSB7XG4gIGNvbnN0IHNldHRpbmdzU2hhc3VtID0gY3JlYXRlSGFzaCgnc2hhMScpXG4gIHNldHRpbmdzU2hhc3VtLnVwZGF0ZShKU09OLnN0cmluZ2lmeShvYmplY3QpKVxuICByZXR1cm4gc2V0dGluZ3NTaGFzdW0uZGlnZXN0KCdoZXgnKVxufVxuIl19